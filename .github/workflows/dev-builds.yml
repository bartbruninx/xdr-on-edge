name: ğŸ§ª Development Builds

on:
  workflow_dispatch:  # Manual trigger

# Security: Explicitly define minimal permissions required
permissions:
  contents: read     # Read repository contents
  actions: read     # Read workflow run information

jobs:
  dev-build:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: ğŸ”§ Install Dependencies
      run: npm ci
    
    - name: ğŸ” Dependency Check
      run: |
        echo "ğŸ“Š Dependency Analysis:"
        npm ls --depth=0
        echo ""
        echo "ğŸ”’ Security Vulnerabilities:"
        npm audit --audit-level=low || true
        echo ""
        echo "ğŸ“¦ Outdated Packages:"
        npm outdated || true
    
    - name: ğŸ› ï¸ Build All Targets
      run: npm run build:all
    
    - name: ğŸ“¤ Upload Development Builds
      uses: actions/upload-artifact@v4
      with:
        name: dev-builds-${{ github.run_number }}
        path: |
          dist-chrome/
          dist-firefox/
          dist-edge/
        retention-days: 30
    
    - name: ğŸ“‹ Generate Build Report
      run: |
        echo "# ğŸ“Š Development Build Report" > build-report.md
        echo "" >> build-report.md
        echo "**Build Date:** $(date)" >> build-report.md
        echo "**Commit:** ${{ github.sha }}" >> build-report.md
        echo "**Node.js:** $(node --version)" >> build-report.md
        echo "**npm:** $(npm --version)" >> build-report.md
        echo "" >> build-report.md
        echo "## ğŸ“¦ Build Sizes" >> build-report.md
        echo "\`\`\`" >> build-report.md
        du -h dist-*/assets/* | sort -hr >> build-report.md
        echo "\`\`\`" >> build-report.md
        echo "" >> build-report.md
        echo "## ğŸ”§ Package Info" >> build-report.md
        echo "\`\`\`json" >> build-report.md
        cat package.json | jq '{name, version, dependencies: (.dependencies | keys), devDependencies: (.devDependencies | keys)}' >> build-report.md
        echo "\`\`\`" >> build-report.md
    
    - name: ğŸ“¤ Upload Build Report
      uses: actions/upload-artifact@v4
      with:
        name: build-report-${{ github.run_number }}
        path: build-report.md
        retention-days: 90
